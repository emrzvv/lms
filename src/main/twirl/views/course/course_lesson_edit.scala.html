@import db.model.{User, Course, Lesson}
@(currentUser: User, course: Course, lesson: Lesson, contentStr: String)

<!DOCTYPE html>
<html lang="en">
@views.html.components.head()
<style>
    .container-with-sidebar {
        display: flex;
    }
    .sidebar {
        width: 280px;
        padding: 1rem;
        color: white;
        min-height: 100vh;
        box-sizing: border-box;
    }
    .main-content {
        flex-grow: 1;
        padding: 1rem;
        margin-left: 0px;
    }

</style>
<body>
@views.html.components.header(currentUser)
<div class="container-with-sidebar">
    @if(course.creatorId == currentUser.id) {
            <!--    TODO: || currentUser is able to edit-->
        @views.html.components.course_edit_sidebar(course)
    }

    <div class="main-content">
        <div class="container mt-5">
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="card border-0">
                        <div class="card-header bg-white border-0">
                            <h2 class="mb-3">@lesson.name</h2>
                        </div>
                        <div class="card-body p-0">
                            <div id="editor" style="min-height: 400px; border: 1px solid #e0e0e0; border-radius: 0.25rem; padding: 1rem;">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary mt-3" id="saveButton" onclick="onSaveEditor()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--@views.html.components.footer()-->

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
@views.html.components.js()
@views.html.components.editor_js_dependencies()
<script>
    const content = @Html(contentStr);
    var editor = new EditorJS({
        readOnly: false,
        holder: 'editor',
        tools: {
            header: {
                class: Header,
                inlineToolbar: ['marker', 'link'],
                config: {
                    placeholder: 'Header'
                },
                shortcut: 'CMD+SHIFT+H'
            },
            image: SimpleImage,
            list: {
                class: List,
                inlineToolbar: true,
                shortcut: 'CMD+SHIFT+L'
            },
            quote: {
                class: Quote,
                inlineToolbar: true,
                config: {
                    quotePlaceholder: 'Enter a quote',
                    captionPlaceholder: 'Quote\'s author',
                },
                shortcut: 'CMD+SHIFT+O'
            },
            warning: Warning,

            marker: {
                class:  Marker,
                shortcut: 'CMD+SHIFT+M'
            },

            code: {
                class:  CodeTool,
                shortcut: 'CMD+SHIFT+C'
            },

            delimiter: Delimiter,

            inlineCode: {
                class: InlineCode,
                shortcut: 'CMD+SHIFT+C'
            },

            linkTool: LinkTool,

            embed: Embed,

            table: {
                class: Table,
                inlineToolbar: true,
                shortcut: 'CMD+ALT+T'
            },
        },
        i18n: {
        messages: {
            "ui": {
                "blockTunes": {
                    "toggler": {
                        "Click to tune": "Нажмите, чтобы настроить",
                        "or drag to move": "или перетащите"
                    },
                },
                "inlineToolbar": {
                    "converter": {
                        "Convert to": "Конвертировать в"
                    }
                },
                "toolbar": {
                    "toolbox": {
                        "Add": "Добавить",
                    }
                },
                "popover": {
                    "Filter": "Поиск",
                    "Nothing found": "Ничего не найдено"
                }
            },

            "toolNames": {
                "Text": "Параграф",
                "Heading": "Заголовок",
                "List": "Список",
                "Warning": "Примечание",
                "Checklist": "Чеклист",
                "Quote": "Цитата",
                "Code": "Код",
                "Delimiter": "Разделитель",
                "Raw HTML": "HTML-фрагмент",
                "Table": "Таблица",
                "Link": "Ссылка",
                "Marker": "Маркер",
                "Bold": "Полужирный",
                "Italic": "Курсив",
                "InlineCode": "Моноширинный",
                "Image": "Картинка"
            },

            "tools": {

                "warning": {
                    "Title": "Название",
                    "Message": "Сообщение",
                },

                "link": {
                    "Add a link": "Вставьте ссылку"
                },

                "stub": {
                    'The block can not be displayed correctly.': 'Блок не может быть отображен'
                },
                "image": {
                    "Caption": "Подпись",
                    "Select an Image": "Выберите файл",
                    "With border": "Добавить рамку",
                    "Stretch image": "Растянуть",
                    "With background": "Добавить подложку",
                },
                "code": {
                    "Enter a code": "Код",
                },
                "linkTool": {
                    "Link": "Ссылка",
                    "Couldn't fetch the link data": "Не удалось получить данные",
                    "Couldn't get this link data, try the other one": "Не удалось получить данные по ссылке, попробуйте другую",
                    "Wrong response format from the server": "Неполадки на сервере",
                },
                "header": {
                    "Header": "Заголовок",
                },
                "paragraph": {
                    "Enter something": "Введите текст"
                },
                "list": {
                    "Ordered": "Нумерованный",
                    "Unordered": "Маркированный",
                }
            },

            "blockTunes": {

                "delete": {
                    "Delete": "Удалить"
                },
                "moveUp": {
                    "Move up": "Переместить вверх"
                },
                "moveDown": {
                    "Move down": "Переместить вниз"
                }
            },
        }
    },
        data: content
    });

    function onSaveEditor() {
        const courseId = '@course.id';
        const lessonId = '@lesson.id'
        editor.save()
                .then((savedData) => {
                    fetch(`/course/${courseId}/edit/lesson/${lessonId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            content: savedData
                        }),
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Lesson updated successfully');
                            // location.reload();
                        } else {
                            console.error('Error:', error);
                            alert('Failed to update lesson');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error when updating lesson');
                    });
                })
                .catch((error) => {
                    console.log('Saving error', error)
                });
    }
</script>
</body>
</html>
