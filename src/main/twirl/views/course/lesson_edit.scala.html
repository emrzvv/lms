@import db.model.{User, Course, Lesson, Task}
@(currentUser: User, course: Course, lesson: Lesson, contentStr: String, tasks: Seq[Task])

<!DOCTYPE html>
<html lang="en">
    @views.html.components.head()
<style>
        .container-with-sidebar {
            display: flex;
        }
        .sidebar {
            width: 280px;
            padding: 1rem;
            color: white;
            min-height: 100vh;
            box-sizing: border-box;
        }
        .main-content {
            flex-grow: 1;
            padding: 1rem;
            margin-left: 0px;
        }
        .task-list {
            margin-top: 2rem;
        }
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
</style>
<body>
    @views.html.components.header(currentUser)
    <div class="container-with-sidebar">
        @if(course.creatorId == currentUser.id) {
            @views.html.components.course_edit_sidebar(course)
        }

        <div class="main-content">
            <div class="container mt-5">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        <div class="card border-0">
                            <div class="card-header bg-white border-0">
                                <h2 class="mb-3">@lesson.name</h2>
                            </div>
                            <div class="card-body p-0">
                                <div id="editor" style="min-height: 400px; border: 1px solid #e0e0e0; border-radius: 0.25rem; padding: 1rem;">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-primary mt-3" id="saveButton" onclick="onSaveEditor()">Сохранить</button>

                            <!-- Секция для списка задач -->
                        <div class="task-list">
                            <h4>Задачи</h4>
                            @for(task <- tasks) {
                                <div class="task-item">
                                    <span>@task.question</span>
                                    <div>
                                        <button class="btn btn-secondary btn-sm me-2" onclick="openTaskModal(event, 'Редактировать задачу', '@task.id', '@task.question', '@task.suggestedAnswer', '@task.points')"><i class="bi bi-pencil-square"></i></button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteTask('@task.id')"><i class="bi bi-trash3"></i></button>
                                    </div>
                                </div>
                            }
                            <button type="button" class="btn btn-dark mt-3" onclick="openTaskModal(event, 'Добавить задачу')">Добавить задачу</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <!-- Диалоговое окно для добавления задачи -->
    <div class="modal fade" id="taskModal" tabindex="-1" role="dialog" aria-labelledby="taskModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="taskModalLabel">Добавить задачу</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    </button>
                </div>
                <div class="modal-body">
                    <form id="taskForm">
                        <div class="form-group mt-3">
                            <label for="taskQuestion">Вопрос</label>
                            <textarea class="form-control" id="taskQuestion" required></textarea>
                        </div>
                        <div class="form-group mt-3">
                            <label for="taskAnswer">Предполагаемый ответ</label>
                            <textarea class="form-control" id="taskAnswer" required></textarea>
                        </div>
                        <div class="form-group mt-3">
                            <label for="taskPoints">Количество баллов за правильный ответ</label>
                            <input type="number" class="form-control" id="taskPoints"
                                    inputmode="numeric"
                                    pattern="\d*"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '');"
                                    required>
                        </div>
                        <input type="hidden" id="taskId">
                        <button type="button" class="btn btn-primary mt-3" onclick="handleSaveTask()">Сохранить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
@views.html.components.js()
@views.html.components.editor_js_dependencies()
<script>
    const content = @Html(contentStr);

    // Инициализация редактора
    var editor = new EditorJS({
        holder: 'editor',
        tools: {
            header: { class: Header, inlineToolbar: true },
            image: SimpleImage,
            list: { class: List, inlineToolbar: true },
            quote: { class: Quote, inlineToolbar: true },
            marker: Marker,
            code: CodeTool,
            delimiter: Delimiter,
            inlineCode: InlineCode,
            linkTool: LinkTool,
            embed: Embed,
            table: { class: Table, inlineToolbar: true },
        },
        data: content
    });

    // Сохранение контента редактора
    function onSaveEditor() {
        const courseId = '@course.id';
        const lessonId = '@lesson.id';
        editor.save().then((savedData) => {
            fetch(`/course/${courseId}/edit/lesson/${lessonId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content: savedData }),
            }).then(response => {
                if (response.ok) {
                    alert('Lesson updated successfully');
                } else {
                    alert('Failed to update lesson');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('Error when updating lesson');
            });
        }).catch((error) => {
            console.log('Saving error', error);
        });
    }

    function openTaskModal(event, title = '', taskId = '', taskQuestion = '', taskAnswer = '', taskPoints = '') {
        event.stopPropagation();
        document.getElementById('taskModalLabel').textContent = title;
        document.getElementById('taskId').value = taskId;
        document.getElementById('taskQuestion').value = taskQuestion;
        document.getElementById('taskAnswer').value = taskAnswer;
        document.getElementById('taskPoints').value = taskPoints;
        $('#taskModal').modal('show');
    }

    function handleSaveTask() {
        const taskId = document.getElementById('taskId').value;
        const question = document.getElementById('taskQuestion').value;
        const answer = document.getElementById('taskAnswer').value;
        const points = parseInt(document.getElementById('taskPoints').value, 10);

        const courseId = '@course.id';
        const lessonId = '@lesson.id';

        const url = `/course/${courseId}/edit/lesson/${lessonId}/task`;
        const method = taskId ? 'PUT' : 'POST';

        const body = {
            lessonId: lessonId,
            question: question,
            suggestedAnswer: answer,
            points: points
        };

        if (taskId) {
            body.taskId = taskId
        }

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
        })
                .then(response => {
                    if (response.ok) {
                        $('#taskModal').modal('hide');
                        alert('Задача успешно сохранена');
                        location.reload();
                    } else {
                        console.error('Error:', response.statusText);
                        alert('Не удалось сохранить задачу');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Произошла ошибка при сохранении задачи');
                });
    }

    function deleteTask(taskId) {
        const courseId = '@course.id';
        const lessonId = '@lesson.id';

        const body = {
            id: taskId
        }

        fetch(`/course/${courseId}/edit/lesson/${lessonId}/task`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        })
        .then(response => {
            if (response.ok) {
                alert('Задача успешно удалена');
                location.reload();
            } else {
                console.error('Error:', response.statusText);
                alert('Не удалось удалить задачу');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Произошла ошибка при удалении задачи');
        });
    }
</script>
</body>
</html>